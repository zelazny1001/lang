import requests
import pandas as pd
import openpyxl
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

FILE_XLSX = "data.xlsx"
URL = "http://localhost:9000/rest/utility?utterance="

def get_table_data(utterance: str):
    response = requests.get(f"{URL}{utterance}")
    response.raise_for_status()
    df_list = pd.read_html(response.text, skiprows=3, header=0)
    if not df_list:
        return {
            "MaxEntIntent": None,
            "MaxEntFeatures": None,
            "TransformerIntent": None
        }
    df_html = df_list[0]
    df_html.columns = pd.Index(["Classifier", "Intent", "Probability", "Features", "Top Intents"])
    df_html = df_html.tail(4)
    df_html["Classifier"] = df_html["Classifier"].str.upper()
    row_linear = df_html.loc[df_html["Classifier"] == "LINEAR SNLP"]
    row_transformer = df_html.loc[df_html["Classifier"] == "TRANSFORMER-GPU"]
    maxent_intent = row_linear["Intent"].iloc[0] if not row_linear.empty else None
    maxent_features = row_linear["Features"].iloc[0] if not row_linear.empty else None
    transformer_intent = row_transformer["Intent"].iloc[0] if not row_transformer.empty else None
    return {
        "MaxEntIntent": maxent_intent,
        "MaxEntFeatures": maxent_features,
        "TransformerIntent": transformer_intent
    }

def main():
    df_input = pd.read_excel(FILE_XLSX, engine="openpyxl")
    required_columns = ["Max Ent Intent", "Transformer Intent", "Max Ent Features"]  # Reordered columns
    for col in required_columns:
        if col not in df_input.columns:
            df_input[col] = None
    for idx, row in df_input.iterrows():
        utterance = str(row["Utterance"]).strip("[]")  # Ensure no extra brackets
        print(f"Processing utterance: {utterance}")  # Show progress
        data = get_table_data(utterance)
        df_input.at[idx, "Max Ent Intent"] = data["MaxEntIntent"]
        df_input.at[idx, "Transformer Intent"] = data["TransformerIntent"]
        df_input.at[idx, "Max Ent Features"] = data["MaxEntFeatures"]
    
    df_input.to_excel(FILE_XLSX, index=False, engine="openpyxl")  # Keep original writing method

    workbook = openpyxl.load_workbook(FILE_XLSX)
    worksheet = workbook.active

    worksheet.column_dimensions["A"].width = 100  # Set "Utterance" column width to 100
    worksheet.column_dimensions["C"].width = 150  # Set "Max Ent Features" column width to 150

    for row in worksheet.iter_rows(min_row=2, max_row=worksheet.max_row, min_col=3, max_col=3):
        for cell in row:
            cell.alignment = openpyxl.styles.Alignment(wrap_text=True)  # Wrap text

    workbook.save(FILE_XLSX)

if __name__ == "__main__":
    main()