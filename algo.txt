import pandas as pd
from openpyxl import Workbook
from openpyxl.utils.dataframe import dataframe_to_rows
from openpyxl.styles import Font
import os
import sys

def transform_csv_to_excel(input_dir, output_dir, output_cols):
    # Parse the comma-separated column names and strip any extra whitespace
    columns_to_extract = [col.strip() for col in output_cols.split(",")]

    # Ensure output directory exists
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
        
    # Process each CSV file in the input directory
    for filename in os.listdir(input_dir):
        if filename.endswith(".csv"):
            input_csv_path = os.path.join(input_dir, filename)
            output_excel_path = os.path.join(output_dir, filename.replace(".csv", ".xlsx"))
            worksheet_name = filename.split('.')[0]  # Get filename without extension for worksheet name

            # Load CSV
            df = pd.read_csv(input_csv_path)

            # Check for required columns
            if not set(columns_to_extract).issubset(df.columns):
                print(f"Skipping '{input_csv_path}': Required columns not present.")
                continue

            # Filter columns based on specified output columns
            filtered_df = df[columns_to_extract]

            # Write to Excel with OpenPyXL to apply formatting
            wb = Workbook()
            ws = wb.active
            ws.title = worksheet_name

            # Append rows to worksheet
            for row in dataframe_to_rows(filtered_df, index=False, header=True):
                ws.append(row)

            # Set column widths if specific columns are used, otherwise default width
            column_widths = {"Branch": 11, "Intent": 37, "Utterance": 110}
            for i, col_name in enumerate(columns_to_extract, start=1):
                col_letter = ws.cell(row=1, column=i).column_letter
                ws.column_dimensions[col_letter].width = column_widths.get(col_name, 15)  # Default width 15 if not specified

            # Set font to Arial 8 for each cell in the worksheet
            font_style = Font(name="Arial", size=8)
            for row in ws.iter_rows():
                for cell in row:
                    cell.font = font_style

            # Freeze the top row
            ws.freeze_panes = "A2"

            # Add filters to each column
            ws.auto_filter.ref = ws.dimensions

            # Save to Excel file, overwriting if it already exists
            wb.save(output_excel_path)

            # Print confirmation message
            print(f"Filename '{output_excel_path}' processed")

# Example usage:
inputDir = "/my/root/dir"
outputDir = "/my/root/dir"
outputCols = "Branch, Intent, Utterance"
transform_csv_to_excel(inputDir, outputDir, outputCols)