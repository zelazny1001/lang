import requests
import pandas as pd
import openpyxl
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

FILE_XLSX = "data.xlsx"
URL = "http://localhost:9000/rest/utility?utterance="

def get_json_data(utterance: str):
    response = requests.get(f"{URL}{utterance}", verify=False)
    response.raise_for_status()
    data = response.json()
    
    intent_info = data.get("IntentInfo", [])
    if not intent_info:
        return {"intent": None, "score": None, "features": None}

    first_intent = intent_info[0]
    intent = first_intent.get("intent")
    score = first_intent.get("score")
    features = first_intent.get("features", [])

    formatted_features = [f"{feature.get('name', 'unknown')}={feature.get('value', 'unknown')}" for feature in features if isinstance(feature, dict)]
    features_str = "[" + ", ".join(f"'{f}'" for f in formatted_features) + "]"

    return {
        "intent": intent,
        "score": score,
        "features": features_str  # Ensures exact format
    }

def main():
    df_input = pd.read_excel(FILE_XLSX, engine="openpyxl")

    # Ensure output columns are cleared before processing
   
 df_input["intent"] = None
    df_input["score"] = None
    df_input["features"] = None

    # Ensure output columns are cleared before processing
    df_input["intent"] = None
    df_input["score"] = None
    df_input["features"] = None    df_input = pd.read_excel(FILE_XLSX, engine="openpyxl")

    required_columns = ["intent", "score", "features"]
    for col in required_columns:
        if col not in df_input.columns:
            df_input[col] = None

    for idx, row in df_input.iterrows():
        utterance = str(row["Utterance"]).strip("[]")
        print(f"Processing utterance: {utterance}")
        data = get_json_data(utterance)
        df_input.at[idx, "intent"] = data["intent"]
        df_input.at[idx, "score"] = data["score"]
        df_input.at[idx, "features"] = data["features"]

    df_input.to_excel(FILE_XLSX, index=False, engine="openpyxl")
    print("Data successfully written to Excel.")  # Debugging print to confirm writing
    print(df_input.head())  # Show a preview of the first few rows to verify data

    workbook = openpyxl.load_workbook(FILE_XLSX)
    worksheet = workbook.active

    worksheet.column_dimensions["A"].width = 100  # "Utterance"
    worksheet.column_dimensions["B"].width = 40   # "intent"
    worksheet.column_dimensions["C"].width = 40   # "score"
    worksheet.column_dimensions["D"].width = 150  # "features"

    for row in worksheet.iter_rows(min_row=2, max_row=worksheet.max_row, min_col=4, max_col=4):
        for cell in row:
            cell.alignment = openpyxl.styles.Alignment(wrap_text=True)

    workbook.save(FILE_XLSX)

if __name__ == "__main__":
    main()
