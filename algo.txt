import requests
import pandas as pd
import openpyxl

INPUT_XLSX = "input.xlsx"
OUTPUT_XLSX = "output.xlsx"
URL = "http://localhost:9000/rest/utility?utterance="

def get_table_data(utterance: str):
    response = requests.get(f"{URL}{utterance}")
    response.raise_for_status()
    df_list = pd.read_html(response.text, skiprows=3, header=0)
    if not df_list:
        return {
            "MaxEntIntent": None,
            "MaxEntFeatures": None,
            "TransformerIntent": None
        }
    df_html = df_list[0]
    df_html.columns = ["Classifier", "Intent", "Probability", "Features", "Top Intents"]
    df_html = df_html.tail(4)
    df_html["Classifier"] = df_html["Classifier"].str.upper()
    row_linear = df_html.loc[df_html["Classifier"] == "LINEAR SNLP"]
    row_transformer = df_html.loc[df_html["Classifier"] == "TRANSFORMER-GPU"]
    maxent_intent = row_linear["Intent"].iloc[0] if not row_linear.empty else None
    maxent_features = row_linear["Features"].iloc[0] if not row_linear.empty else None
    transformer_intent = row_transformer["Intent"].iloc[0] if not row_transformer.empty else None
    return {
        "MaxEntIntent": maxent_intent,
        "MaxEntFeatures": maxent_features,
        "TransformerIntent": transformer_intent
    }

def main():
    df_input = pd.read_excel(INPUT_XLSX, engine="openpyxl")
    required_columns = ["Max Ent Intent", "Max Ent Features", "Transformer Intent"]
    for col in required_columns:
        if col not in df_input.columns:
            df_input[col] = None
    for idx, row in df_input.iterrows():
        utterance = str(row["Utterance"])
        data = get_table_data(utterance)
        df_input.at[idx, "Max Ent Intent"] = data["MaxEntIntent"]
        df_input.at[idx, "Max Ent Features"] = data["MaxEntFeatures"]
        df_input.at[idx, "Transformer Intent"] = data["TransformerIntent"]
    df_input.to_excel(OUTPUT_XLSX, index=False, engine="openpyxl")

if __name__ == "__main__":
    main()