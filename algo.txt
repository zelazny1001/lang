import requests
import json
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

URL = "http://localhost:9000/rest/utility?utterance="
UTTERANCE = "test utterance here"

response = requests.get(f"{URL}{UTTERANCE}", verify=False)
response.raise_for_status()
data = response.json()

print("\nFull JSON Response:\n", json.dumps(data, indent=2))

# Locate the activity log
activity_log = data.get("activityLog", [])
if not activity_log:
    print("No activityLog found in response.")
    exit()

# Find the correct log entry with threadName and message
selected_entry = None
for entry in activity_log:
    if entry.get("message") == "Report for component RESPONSE_BUILDER" and "threadName" in entry:
        selected_entry = entry
        break

if not selected_entry:
    print("No matching log entry found for 'Report for component RESPONSE_BUILDER'.")
    exit()

print("\nFound matching activity log entry:\n", json.dumps(selected_entry, indent=2))

# Extract intent information from "output" > "IntentInfo"
output_data = selected_entry.get("output", {})
intent_info = output_data.get("IntentInfo", [])

if not intent_info:
    print("No IntentInfo found in the log entry.")
    exit()

# Extract the first intent (assuming the first is the most relevant)
first_intent = intent_info[0]
intent = first_intent.get("intent")
score = first_intent.get("score")
features = first_intent.get("features", [])

if not features:
    print(f"Intent found: {intent}, Score: {score}, but 'features' is empty.")
else:
    formatted_features = [f"{feature.get('name', 'unknown')}={feature.get('value', 'unknown')}" for feature in features if isinstance(feature, dict)]
    features_str = "[" + ", ".join(f"'{f}'" for f in formatted_features) + "]"
    print(f"Extracted intent: {intent}, Score: {score}, Features: {features_str}")
