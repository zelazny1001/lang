let cachedTranscriptionContent = null;
let cachedTranscriptionData = [];
let selectedRow = null;
let clickedLineIndex = null;

const playAudioButton = document.getElementById("playAudioButton");

document.getElementById("groundTruthFileInput").addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        populateTextArea("groundTruth", reader.result);
        if (cachedTranscriptionContent) {
            processTranscriptionFile(cachedTranscriptionContent);
        }
    };
    reader.readAsText(file);
});

document.getElementById("transcriptionFileInput").addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        cachedTranscriptionContent = reader.result;
        processTranscriptionFile(cachedTranscriptionContent);
    };
    reader.readAsText(file);
});

document.getElementById("compareButton").addEventListener("click", () => {
    const groundTruthDiv = document.getElementById("groundTruth");
    const transcriptionDiv = document.getElementById("transcription");

    const groundTruthText = groundTruthDiv.innerText.trim();
    const transcriptionText = transcriptionDiv.innerText.trim();

    const exclusionInput = document.getElementById("exclude").value;
    const exclusions = parseExclusions(exclusionInput);

    const preprocessedGroundTruth = preprocessText(groundTruthText, exclusions).split(/\s+/);
    const preprocessedTranscription = preprocessText(transcriptionText, exclusions).split(/\s+/);

    // Calculate WER
    const werResult = calculateWER(preprocessedGroundTruth.join(" "), preprocessedTranscription.join(" "));
    document.getElementById("werResult").value = `WER: ${werResult.wer}%, S: ${werResult.substitutions}, D: ${werResult.deletions}, I: ${werResult.insertions}, N: ${werResult.total}`;
    document.getElementById("substitutionDetails").value = werResult.details.substitutions.reverse().join("\n");
    document.getElementById("deletionDetails").value = werResult.details.deletions.reverse().join("\n");
    document.getElementById("insertionDetails").value = werResult.details.insertions.reverse().join("\n");

    // Calculate PER
    const perResult = calculatePER(preprocessedGroundTruth.join(" "), preprocessedTranscription.join(" "));
    document.getElementById("perResult").value = `PER: ${perResult.wer}%, S: 0, D: ${perResult.deletions}, I: ${perResult.insertions}, N: ${perResult.total}`;
    document.getElementById("perDeletionDetails").value = perResult.details.deletions.join("\n");
    document.getElementById("perInsertionDetails").value = perResult.details.insertions.join("\n");

    // highlight deletions in ground truth
    const highlightedGroundTruth = alignPER(preprocessedGroundTruth, perResult.details.deletions, "deletion");
    // highlight insertions in transcription
    const highlightedTranscription = alignPER(preprocessedTranscription, perResult.details.insertions, "insertion");

    groundTruthDiv.innerHTML = highlightedGroundTruth.join(" ");
    transcriptionDiv.innerHTML = highlightedTranscription.join(" ");
});

document.getElementById("clearButton").addEventListener("click", () => {
    const groundTruthDiv = document.getElementById("groundTruth");
    const transcriptionDiv = document.getElementById("transcription");

    groundTruthDiv.innerText = groundTruthDiv.innerText;
    transcriptionDiv.innerText = transcriptionDiv.innerText;

    document.getElementById("werResult").value = `WER: %, S: , D: , I: , N: `;
    document.getElementById("perResult").value = `PER: %, S: 0, D: , I: , N: `;

    document.getElementById("substitutionDetails").value = "";
    document.getElementById("deletionDetails").value = "";
    document.getElementById("insertionDetails").value = "";
    document.getElementById("perDeletionDetails").value = "";
    document.getElementById("perInsertionDetails").value = "";
});

function calculateWER(groundTruth, transcription) {
    const groundWords = groundTruth.split(/\s+/);
    const transcribedWords = transcription.split(/\s+/);
    const m = groundWords.length;
    const n = transcribedWords.length;

    const dp = Array(m + 1).fill().map(() => Array(n + 1).fill(0));

    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;

    const details = { substitutions: [], deletions: [], insertions: [] };

    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (groundWords[i - 1] === transcribedWords[j - 1]) {
                dp[i][j] = dp[i - 1][j - 1];
            } else {
                dp[i][j] = 1 + Math.min(
                    dp[i - 1][j - 1],
                    dp[i - 1][j],
                    dp[i][j - 1]
                );
            }
        }
    }

    let i = m, j = n;
    let substitutions = 0, deletions = 0, insertions = 0;

    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && groundWords[i - 1] === transcribedWords[j - 1]) {
            i--;
            j--;
        } else if (i > 0 && (j === 0 || dp[i][j] === dp[i - 1][j] + 1)) {
            deletions++;
            details.deletions.push(groundWords[i - 1]);
            i--;
        } else if (j > 0 && (i === 0 || dp[i][j] === dp[i][j - 1] + 1)) {
            insertions++;
            details.insertions.push(transcribedWords[j - 1]);
            j--;
        } else {
            substitutions++;
            details.substitutions.push(`${groundWords[i - 1]} -> ${transcribedWords[j - 1]}`);
            i--;
            j--;
        }
    }

    const wer = ((substitutions + deletions + insertions) / m) * 100;
    return {
        wer: Math.min(wer, 100).toFixed(2),
        substitutions,
        deletions,
        insertions,
        total: m,
        details
    };
}

function calculatePER(groundTruth, transcription) {
    const groundWords = groundTruth.split(/\s+/);
    const transcribedWords = transcription.split(/\s+/);
    const m = groundWords.length;

    const groundWordCounts = {};
    const transcribedWordCounts = {};

    groundWords.forEach(word => {
        groundWordCounts[word] = (groundWordCounts[word] || 0) + 1;
    });

    transcribedWords.forEach(word => {
        transcribedWordCounts[word] = (transcribedWordCounts[word] || 0) + 1;
    });

    let deletions = 0, insertions = 0;
    const details = { deletions: [], insertions: [] };

    const allWords = new Set([...Object.keys(groundWordCounts), ...Object.keys(transcribedWordCounts)]);

    allWords.forEach(word => {
        const groundCount = groundWordCounts[word] || 0;
        const transcribedCount = transcribedWordCounts[word] || 0;

        if (groundCount > transcribedCount) {
            const diff = groundCount - transcribedCount;
            deletions += diff;
            for (let i = 0; i < diff; i++) {
                details.deletions.push(word);
            }
        } else if (transcribedCount > groundCount) {
            const diff = transcribedCount - groundCount;
            insertions += diff;
            for (let i = 0; i < diff; i++) {
                details.insertions.push(word);
            }
        }
    });

    const per = ((insertions + deletions) / m) * 100;

    return {
        wer: Math.min(per, 100).toFixed(2),
        deletions,
        insertions,
        total: m,
        details
    };
}

function alignPER(text, edits, type) {
    const editsCopy = [...edits];
    const reversedText = [...text].reverse();

    const highlightedReversed = reversedText.map(word => {
        const index = editsCopy.indexOf(word);
        if (index !== -1) {
            editsCopy.splice(index, 1);
            return `<span class="highlight ${type}">${word}</span>`;
        }
        return word;
    });

    return highlightedReversed.reverse();
}

function preprocessText(text, exclusions) {
    text = text.replace(/\n+/g, " ");
    text = text.replace(/<.*?>/g, " ");
    text = text.replace(/[.,!?;]/g, " ").trim();
    exclusions.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, "gi");
        text = text.replace(regex, " ");
    });
    return text.replace(/\s+/g, " ");
}

function parseExclusions(exclusionInput) {
    return exclusionInput.split('|').map(word => word.trim()).filter(word => word !== "");
}

function populateTextArea(areaId, content) {
    const textArea = document.getElementById(areaId);
    textArea.innerText = content;
}

// transcript click on line to identify audio play zone

document.getElementById("transcription").addEventListener("click", () => {
    const transcriptionDiv = document.getElementById("transcription");
    clickedLineIndex = getCursorLineIndex(transcriptionDiv);
});

function getCursorLineIndex(textArea) {
    const selection = window.getSelection();
    if (!selection.rangeCount) return null;

    const range = selection.getRangeAt(0);
    let lineIndex = 0;

    for (const node of textArea.childNodes) {
        if (range.startContainer === node || node.contains(range.startContainer)) {
            return lineIndex;
        }
        lineIndex++;
    }
    return null;
}

// play transcript audio for text under cursor

playAudioButton.addEventListener("click", () => {
    if (clickedLineIndex === null) {
        return;
    }

    if (!cachedTranscriptionData || !cachedTranscriptionData[clickedLineIndex]) {
        return;
    }

    const matchingRow = cachedTranscriptionData[clickedLineIndex];

    const startTime = matchingRow.start / 50;
    const endTime = matchingRow.end / 50;

    if (isNaN(startTime) || isNaN(endTime) || startTime >= endTime) {
        alert("Invalid start or end time.");
        return;
    }

    const audioFilePath = `wav/${matchingRow.filename}.wav`;
    const audio = new Audio(audioFilePath);
    audio.currentTime = startTime;
    audio.play();

    setTimeout(() => {
        audio.pause();
    }, (endTime - startTime) * 1000);
});

// call purpose summary

document.getElementById("purposeSummaryButton").addEventListener("click", async () => {
    const transcriptionDiv = document.getElementById("transcription");
    const lineIndex = getCursorLineIndex(transcriptionDiv);

    if (lineIndex === null || lineIndex < 0) {
        alert("Failed to determine the line index.");
        return;
    }

    const allLines = transcriptionDiv.innerText.split("\n");
    const assembledText = allLines.slice(0, lineIndex + 1).join(" ").trim(); // all lines from start to cursor index

    const payload = { conversation: assembledText };

    try {
        const response = await fetch("http://laude_server.com:8000/fetchdata", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });

        if (!response.ok) {
            alert("Failed to fetch data from the server.");
            return;
        }

        const responseText = await response.text();

        const outputDisplay = document.getElementById("outputDisplay");
        outputDisplay.innerText = responseText;
    } catch (error) {
        alert("An error occurred while making the request: " + error.message);
    }
});

------------------------------------

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta viewport="width=device-width, initial-scale=1.0">
    <title>Text Comparison with WER and PER</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- File Loader and Text Areas -->
        <div class="file-loader-container">
            <div class="file-loader">
                <label for="groundTruthFileInput">Ground Truth File:</label>
                <input type="file" id="groundTruthFileInput">
            </div>
            <div class="file-loader">
                <label for="transcriptionFileInput">Transcription File:</label>
                <input type="file" id="transcriptionFileInput">
            </div>
        </div>
        <label for="exclude">Exclude Tokens (pipe-separated):</label>
        <input type="text" id="exclude" name="exclude" placeholder="Enter tokens separated by |">
        
        <div class="text-area-container">
            <div class="text-box">
                <label for="groundTruth">Ground Truth:</label>
                <div id="groundTruth" class="text-display" contenteditable="true"></div>
                <div class="button-container">
                    <button id="compareButton">Compare</button>
                </div>
            </div>
            <div class="text-box">
                <label for="transcription">Transcription:</label>
                <div id="transcription" class="text-display" contenteditable="true"></div>
                <div class="button-container">
                    <button id="playAudioButton">Play Audio</button>
                    <button id="purposeSummaryButton">Purpose Summary</button>
                    <button id="clearButton">Clear</button>
                </div>
            </div>
        </div>

        <div class="output-container">
            <label for="outputDisplay" class="output-label">Call Purpose Summary:</label>
            <div id="outputDisplay" class="output-display">this is the call purpose summary</div>
        </div>

        <!-- Results -->
        <div class="results-container">
            <div class="results-box">
                <input type="text" id="werResult" readonly value="WER: %, S: , D: , I: , N: ">
                <input type="text" id="perResult" readonly value="PER: %, S: 0, D: , I: , N: ">
            </div>
        </div>
        
        <!-- WERDetails -->
        <div class="details-container">
            <h3>WER:</h3>
            <div class="wer-item">
                <label for="substitutionDetails">Substitutions:</label>
                <textarea id="substitutionDetails" class="details-box" readonly></textarea>
            </div>
            <div class="wer-item">
                <label for="deletionDetails">Deletions:</label>
                <textarea id="deletionDetails" class="details-box" readonly></textarea>
            </div>
            <div class="wer-item">
                <label for="insertionDetails">Insertions:</label>
                <textarea id="insertionDetails" class="details-box" readonly></textarea>
            </div>
        </div>

        <!-- PER Details -->
        <div class="details-container">
            <h3>PER:</h3>
            <!-- Placeholder for alignment -->
            <div class="wer-item placeholder-item">
                <!-- Empty div to occupy space of Substitutions box -->
            </div>
            <div class="wer-item">
                <label for="perDeletionDetails">Deletions:</label>
                <textarea id="perDeletionDetails" class="details-box" readonly></textarea>
            </div>
            <div class="wer-item">
                <label for="perInsertionDetails">Insertions:</label>
                <textarea id="perInsertionDetails" class="details-box" readonly></textarea>
            </div>
        </div>

    </div>

    <script src="js/script.js"></script>
</body>
</html>

--------------------------------------------

body {
    font-family: Arial, sans-serif;
    margin: 20px;
}

.container {
    max-width: 900px;
    margin: 0 auto;
}

label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
}

input[type="text"] {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.file-loader-container {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 15px;
}

.file-loader {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

#groundTruthFileInput, #transcriptionFileInput {
    flex: 1;
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.text-area-container {
    display: flex;
    justify-content: space-between;
    gap: 25px;
    margin-bottom: 15px;
}

.text-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.text-display {
    width: 100%;
    height: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 10px;
    overflow-y: auto;
    background-color: white;
    font-family: Arial, sans-serif;
    font-size: 14px;
    color: black;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.button-container {
    display: flex;
    justify-content: center;
    margin-top: 10px;
}

button {
    padding: 10px 15px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#compareButton {
    background-color: #DC3545;
    color: white;
    padding: 10px 10px;
    margin: 5px 5px;
}

#clearButton {
    background-color: #007BFF;
    color: white;
    padding: 10px 10px;
    margin: 5px 5px;
}

#playAudioButton, #purposeSummaryButton {
    background-color: #00FF7B;
    color: black;
    padding: 10px 10px;
    margin: 5px 5px;
}

.highlight.deletion {
    background-color: red;
    color: white;
}

.highlight.substitution {
    background-color: orange;
}

.highlight.insertion {
    background-color: blue;
	color: white;
}

.results-container {
    display: flex;
    align-items: center;
	margin-left: 100px;
    margin-top: 20px;
}

.results-box input[type="text"] {
    font-size: 18px;
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #f9f9f9;
    color: black;
    flex: 0 1 auto;
    width: auto;
    min-width: 300px;
    max-width: 450px;
    text-align: center;
}

.details-container {
    display: flex;
    flex-wrap: wrap;
    gap: 40px;
    margin-top: 20px;
    align-items: flex-start;
}

.wer-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
    min-width: 100px;
}

.details-box {
    width: 100%;
    height: 100px;
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: none;
    background-color: #f9f9f9;
    color: black;
}

.placeholder-item {
    visibility: hidden;
    height: 0;
	width: 200px;
    margin-bottom: 15px;
}

.output-container {
    display: flex;
    align-items: center;
    margin-top: 20px;
    gap: 10px;
}

.output-label {
    font-family: Arial, sans-serif;
    font-size: 14px;
    font-weight: bold;
    color: black;
    white-space: nowrap;
}

.output-display {
    flex: 1;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #f9f9f9;
    font-family: Arial, sans-serif;
    font-size: 14px;
    color: black;
    height: 60px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    text-align: left;
}